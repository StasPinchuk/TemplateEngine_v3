<Page x:Class="TemplateEngine_v3.Views.Pages.TemplatePreviewPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"   
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:model="clr-namespace:TemplateEngine_v3.Models"
      xmlns:conv="clr-namespace:TemplateEngine_v3.Converters"
      xmlns:sys="clr-namespace:System;assembly=mscorlib"
      xmlns:local="clr-namespace:TemplateEngine_v3.Views.Pages"
      mc:Ignorable="d" 
      d:DesignHeight="450" d:DesignWidth="800"
      x:Name="templatePreviewPage"
      Title="TemplatePreviewPage">

    <Page.Resources>
        <conv:EmptyStringToVisibilityConverter x:Key="EmptyStringToVisibilityConverter"/>
    </Page.Resources>

    <DockPanel LastChildFill="True">

        <materialDesign:DrawerHost x:Name="DrawerHost"
                                   Width="{Binding ElementName=templatePreviewPage, Path=ActualWidth}"
                                   Height="{Binding ElementName=templatePreviewPage, Path=ActualHeight}"
                                   HorizontalAlignment="Stretch"
                                   VerticalAlignment="Stretch"
                                   DrawerClosing="DrawerHost_DrawerClosing"
                                   BottomDrawerBackground="{DynamicResource SecondaryHueLightBrush}"
                                   BottomDrawerCornerRadius="20 20 0 0">
            <Grid Margin="20">

                <Grid.RowDefinitions>
                    <RowDefinition Height="50"/>
                    <RowDefinition Height="10"/>
                    <RowDefinition Height="30"/>
                    <RowDefinition Height="10"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Grid Grid.Row="0">

                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="auto"/>
                        <ColumnDefinition Width="auto"/>
                    </Grid.ColumnDefinitions>


                    <TextBox Style="{StaticResource MaterialDesignOutlinedTextBox}"
                             Text="{Binding OrderString, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             materialDesign:HintAssist.Hint="Строка заказа"
                             Grid.Column="0"/>

                    <ComboBox Style="{StaticResource MaterialDesignOutlinedComboBox}"
                              ItemsSource="{Binding Branches, UpdateSourceTrigger=PropertyChanged}"
                              SelectedItem="{Binding Branch, UpdateSourceTrigger=PropertyChanged}"
                              materialDesign:HintAssist.Hint="Филиал"
                              Margin="20,0"
                              Grid.Column="1"/>

                    <Button Content="Проверить"
                            Background="Green"
                            BorderBrush="Green"
                            Command="{Binding CreateSpecCommand}"
                            Grid.Column="2"/>

                    <Button Content="Материалы"
                            Background="Green"
                            BorderBrush="Green"
                            Command="{Binding GetMaterialsCommand}"
                            Grid.Column="3" 
                            Margin="10,0,0,0"/>
                </Grid>

                <TextBlock Text="{Binding Relations.Designation, UpdateSourceTrigger=PropertyChanged}"
                           Grid.Row="2"/>

                <Grid Grid.Row="4">
                    <TreeView x:Name="MyTreeView"
                              ItemsSource="{Binding Details, UpdateSourceTrigger=PropertyChanged}"
                              PreviewMouseRightButtonDown="TreeView_PreviewMouseRightButtonDown">
                        <TreeView.Resources>

                            <!-- Detail -->
                            <HierarchicalDataTemplate DataType="{x:Type model:Node}" ItemsSource="{Binding Groups}">
                                <StackPanel>
                                    <TextBlock Text="{Binding Name}" 
                                               FontSize="14"
                                               FontWeight="Bold"/>
                                    <TextBlock Text="{Binding Type}" />
                                    <TextBlock Text="{Binding Designation}" 
                                               Visibility="{Binding Designation, Converter={StaticResource EmptyStringToVisibilityConverter}}"/>
                                    <TextBlock Visibility="{Binding NodeComment, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                        <Run Text="Комментарий: "/>
                                        <Run Text="{Binding NodeComment}"/>
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding Amount.Value, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                        <Run Text="Количество: "/>
                                        <Run Text="{Binding Amount.Value}"/>
                                    </TextBlock>
                                </StackPanel>
                            </HierarchicalDataTemplate>

                            <!-- GroupNode -->
                            <HierarchicalDataTemplate DataType="{x:Type model:GroupNode}" ItemsSource="{Binding Children}">
                                <TextBlock Text="{Binding Name}" />
                            </HierarchicalDataTemplate>
                            <HierarchicalDataTemplate DataType="{x:Type model:Operation}" ItemsSource="{Binding BranchDivisionDetails}">
                                <TextBlock Text="{Binding Name}" />
                            </HierarchicalDataTemplate>

                            <!-- BranchDivisionDetails -->
                            <HierarchicalDataTemplate DataType="{x:Type model:BranchDivisionDetails}">
                                <StackPanel Visibility="{Binding UnitEquipment, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                    <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                    <TextBlock Visibility="{Binding Branch.Name, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                                <Run Text="Филиал: "
                                                        FontWeight="Bold"/>
                                                <Run Text="{Binding Branch.Name}"/>
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding UnitEquipment, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                                <Run Text="Название оборудования: "
                                                        FontWeight="Bold"/>
                                                <Run Text="{Binding UnitEquipment}"/>
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding DivisionCode, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                                <Run Text="Код подразделения: "
                                                        FontWeight="Bold"/>
                                                <Run Text="{Binding DivisionCode}"/>
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding UnitEquipment, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                                <Run Text="Название оборудования: "
                                                        FontWeight="Bold"/>
                                                <Run Text="{Binding UnitEquipment}"/>
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding Materials.Name.Value, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                                <Run Text="Название материала: "
                                                        FontWeight="Bold"/>
                                                <Run Text="{Binding Materials.Name.Value}"/>
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding Materials.Consumption.Value, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                                <Run Text="Расход материала: "
                                                        FontWeight="Bold"/>
                                                <Run Text="{Binding Materials.Consumption.Value}"/>
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding Materials.Unit, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                                <Run Text="Единицы измерения: "
                                                        FontWeight="Bold"/>
                                                <Run Text="{Binding Materials.Unit}"/>
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding UsageCondition, Converter={StaticResource EmptyStringToVisibilityConverter}}">
                                                <Run Text="Условия применения операции: "
                                                        FontWeight="Bold"/>
                                                <Run Text="{Binding UsageCondition}"/>
                                    </TextBlock>
                                </StackPanel>
                            </HierarchicalDataTemplate>

                            <!-- Parameter -->
                            <DataTemplate DataType="{x:Type model:ConditionEvaluator}">
                                <StackPanel Orientation="Vertical">
                                    <TextBlock Text="{Binding Name}"
                                                FontWeight="Bold"
                                                FontSize="14"/>
                                    <TextBlock Text="{Binding Value}" />
                                </StackPanel>
                            </DataTemplate>

                        </TreeView.Resources>
                    </TreeView>

                </Grid>
            </Grid>
            <materialDesign:DrawerHost.RightDrawerContent>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="40"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            Width="30"
                            Height="30"
                            HorizontalAlignment="Left"
                            Command="{Binding BackPageCommand}"
                            Grid.Row="0">
                        <materialDesign:PackIcon Kind="ArrowLeft"
                                                 Width="25"
                                                 Height="25"/>
                    </Button>
                    <Frame x:Name="RightDrawerContext"
                           NavigationUIVisibility="Hidden"
                           Grid.Row="1"/>
                </Grid>
            </materialDesign:DrawerHost.RightDrawerContent>
        </materialDesign:DrawerHost>
    </DockPanel>
</Page>
